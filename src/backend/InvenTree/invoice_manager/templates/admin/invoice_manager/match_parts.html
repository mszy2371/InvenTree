{% extends "admin/base_site.html" %}
{% load i18n admin_urls static %}

{% block extrahead %}
{{ block.super }}
<style>
    .match-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }
    .invoice-header {
        background: #2d3748;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #4299e1;
        color: #e2e8f0;
    }
    .invoice-header h2 {
        margin: 0 0 10px 0;
        color: #fff;
    }
    .invoice-meta {
        display: flex;
        gap: 30px;
        color: #a0aec0;
    }
    .invoice-meta span {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .invoice-meta strong {
        color: #fff;
    }

    .items-table {
        width: 100%;
        border-collapse: collapse;
        background: #1a202c;
        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        border-radius: 8px;
        overflow: hidden;
    }
    .items-table th {
        background: #2d3748;
        color: #e2e8f0;
        padding: 12px 15px;
        text-align: left;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 12px;
    }
    .items-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #2d3748;
        vertical-align: middle;
        color: #e2e8f0;
    }
    .items-table tr:hover {
        background: #2d3748;
    }
    .items-table tr.matched {
        background: rgba(72, 187, 120, 0.2);
    }
    .items-table tr.unmatched {
        background: rgba(237, 137, 54, 0.15);
    }

    .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
    }
    .status-matched {
        background: #48bb78;
        color: #1a202c;
    }
    .status-unmatched {
        background: #ed8936;
        color: #1a202c;
    }

    .part-select {
        width: 100%;
        min-width: 300px;
        padding: 8px;
        border: 1px solid #4a5568;
        border-radius: 4px;
        font-size: 14px;
        background: #2d3748;
        color: #e2e8f0;
    }
    .part-select:focus {
        border-color: #4299e1;
        outline: none;
        box-shadow: 0 0 0 2px rgba(66,153,225,0.4);
    }

    .search-input {
        width: 100%;
        padding: 8px 12px;
        border: 2px solid #4299e1;
        border-radius: 4px;
        font-size: 14px;
        margin-bottom: 5px;
        background: #2d3748;
        color: #fff;
    }
    .search-input::placeholder {
        color: #718096;
    }
    .search-results {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #4a5568;
        border-radius: 4px;
        background: #2d3748;
        display: none;
        position: absolute;
        z-index: 1000;
        width: 400px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    .search-results.show {
        display: block;
    }
    .search-result-item {
        padding: 10px 12px;
        cursor: pointer;
        border-bottom: 1px solid #4a5568;
        color: #e2e8f0;
    }
    .search-result-item:hover {
        background: #4a5568;
    }
    .search-result-item.selected {
        background: #4299e1;
        color: white;
    }
    .search-result-item small {
        color: #a0aec0;
    }

    .part-search-container {
        position: relative;
    }
    .selected-part {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px;
        background: rgba(66,153,225,0.2);
        border-radius: 4px;
        margin-top: 5px;
    }
    .selected-part .remove-btn {
        background: #e53e3e;
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        cursor: pointer;
        font-size: 12px;
    }

    .btn-group {
        margin-top: 20px;
        display: flex;
        gap: 10px;
    }
    .btn {
        padding: 10px 24px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: background 0.2s;
    }
    .btn-primary {
        background: #4299e1;
        color: white;
    }
    .btn-primary:hover {
        background: #3182ce;
    }
    .btn-success {
        background: #48bb78;
        color: #1a202c;
    }
    .btn-success:hover {
        background: #38a169;
    }
    .btn-secondary {
        background: #718096;
        color: white;
    }
    .btn-secondary:hover {
        background: #4a5568;
    }

    .summary-box {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }
    .summary-item {
        padding: 15px 25px;
        border-radius: 8px;
        text-align: center;
    }
    .summary-item.total {
        background: rgba(66,153,225,0.2);
        border: 1px solid #4299e1;
    }
    .summary-item.matched {
        background: rgba(72,187,120,0.2);
        border: 1px solid #48bb78;
    }
    .summary-item.unmatched {
        background: rgba(237,137,54,0.2);
        border: 1px solid #ed8936;
    }
    .summary-item .number {
        font-size: 24px;
        font-weight: bold;
        color: #fff;
    }
    .summary-item .label {
        font-size: 12px;
        color: #a0aec0;
        text-transform: uppercase;
    }

    .auto-match-suggestion {
        font-size: 11px;
        color: #a0aec0;
        margin-top: 5px;
    }
    .auto-match-suggestion a {
        color: #63b3ed;
        cursor: pointer;
        text-decoration: underline;
    }
    .auto-match-suggestion a:hover {
        color: #90cdf4;
    }

    /* Create Part Button */
    .btn-create-part {
        background: #9f7aea;
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        cursor: pointer;
        margin-left: 5px;
    }
    .btn-create-part:hover {
        background: #805ad5;
    }

    /* Modal styles */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 2000;
        justify-content: center;
        align-items: center;
    }
    .modal-overlay.show {
        display: flex;
    }
    .modal-content {
        background: #2d3748;
        border-radius: 8px;
        padding: 24px;
        width: 500px;
        max-width: 90%;
        box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #4a5568;
    }
    .modal-header h3 {
        margin: 0;
        color: #fff;
    }
    .modal-close {
        background: none;
        border: none;
        color: #a0aec0;
        font-size: 24px;
        cursor: pointer;
    }
    .modal-close:hover {
        color: #fff;
    }
    .form-group {
        margin-bottom: 15px;
    }
    .form-group label {
        display: block;
        color: #a0aec0;
        margin-bottom: 5px;
        font-size: 13px;
    }
    .form-group input, .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #4a5568;
        border-radius: 4px;
        background: #1a202c;
        color: #fff;
        font-size: 14px;
    }
    .form-group input:focus, .form-group select:focus {
        border-color: #4299e1;
        outline: none;
    }
    .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
    }
</style>
{% endblock extrahead %}

{% block content %}
<div class="match-container">
    <div class="invoice-header">
        <h2>üßæ Invoice {{ invoice.invoice_number }}</h2>
        <div class="invoice-meta">
            <span>üì¶ Supplier: <strong>{{ invoice.supplier.name }}</strong></span>
            <span>üìÖ Date: <strong>{{ invoice.invoice_date|default:"N/A" }}</strong></span>
            <span>üí∞ Total: <strong>¬£{{ invoice.invoice_total|floatformat:2 }}</strong></span>
        </div>
    </div>

    <div class="summary-box">
        <div class="summary-item total">
            <div class="number">{{ total_items }}</div>
            <div class="label">Total Items</div>
        </div>
        <div class="summary-item matched">
            <div class="number">{{ matched_count }}</div>
            <div class="label">Matched</div>
        </div>
        <div class="summary-item unmatched">
            <div class="number">{{ unmatched_count }}</div>
            <div class="label">Need Matching</div>
        </div>
    </div>

    <form method="post" id="match-form">
        {% csrf_token %}

        <table class="items-table">
            <thead>
                <tr>
                    <th style="width: 40px;">#</th>
                    <th>Invoice Description</th>
                    <th style="width: 80px;">SKU</th>
                    <th style="width: 60px;">Qty</th>
                    <th style="width: 80px;">Price</th>
                    <th style="width: 400px;">Match to Part</th>
                    <th style="width: 100px;">Status</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr class="{% if item.matched %}matched{% else %}unmatched{% endif %}">
                    <td>{{ forloop.counter }}</td>
                    <td>
                        <strong>{{ item.description }}</strong>
                    </td>
                    <td>{{ item.seller_sku|default:"-" }}</td>
                    <td>{{ item.quantity|floatformat:0 }}</td>
                    <td>¬£{{ item.unit_price|floatformat:2 }}</td>
                    <td>
                        <div class="part-search-container">
                            <input type="text"
                                   class="search-input"
                                   placeholder="Search parts..."
                                   data-item-id="{{ item.pk }}"
                                   value="{% if item.part %}{{ item.part.name }}{% endif %}"
                                   autocomplete="off">
                            <input type="hidden"
                                   name="part_{{ item.pk }}"
                                   value="{% if item.part %}{{ item.part.pk }}{% endif %}"
                                   class="part-id-input">
                            <div class="search-results" id="results-{{ item.pk }}"></div>
                            {% if not item.matched and item.suggestions %}
                            <div class="auto-match-suggestion">
                                Suggestions:
                                {% for suggestion in item.suggestions %}
                                <a onclick="selectPart({{ item.pk }}, {{ suggestion.pk }}, '{{ suggestion.name|escapejs }}')">
                                    {{ suggestion.name|truncatechars:40 }}
                                </a>{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            </div>
                            {% endif %}
                            {% if not item.matched %}
                            <button type="button" class="btn-create-part" onclick="openCreatePartModal({{ item.pk }}, '{{ item.description|escapejs }}', '{{ item.seller_sku|default:""|escapejs }}', {{ item.unit_price }})">
                                ‚ûï Create New Part
                            </button>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        {% if item.matched %}
                        <span class="status-badge status-matched">‚úì Matched</span>
                        {% else %}
                        <span class="status-badge status-unmatched">‚ö† Unmatched</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="btn-group">
            <button type="submit" name="action" value="save" class="btn btn-primary">
                üíæ Save Matches
            </button>
            <button type="submit" name="action" value="save_and_stock" class="btn btn-success">
                üì¶ Save & Create Stock
            </button>
            <a href="{% url 'admin:invoice_manager_invoice_changelist' %}" class="btn btn-secondary">
                ‚Üê Back to Invoices
            </a>
        </div>
    </form>
</div>

<!-- Create Part Modal -->
<div class="modal-overlay" id="createPartModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>‚ûï Create New Part</h3>
            <button class="modal-close" onclick="closeCreatePartModal()">&times;</button>
        </div>
        <form id="createPartForm">
            <input type="hidden" id="modalItemId" value="">

            <div class="form-group">
                <label>Part Name *</label>
                <input type="text" id="partName" required>
            </div>

            <div class="form-group">
                <label>Description</label>
                <input type="text" id="partDescription">
            </div>

            <div class="form-group">
                <label>Category *</label>
                <select id="partCategory" required>
                    <option value="">-- Select Category --</option>
                    {% for category in categories %}
                    <option value="{{ category.pk }}">{{ category.pathstring }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label>Supplier SKU</label>
                <input type="text" id="partSKU">
            </div>

            <div class="form-group">
                <label>Price (¬£)</label>
                <input type="number" id="partPrice" step="0.01">
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeCreatePartModal()">Cancel</button>
                <button type="submit" class="btn btn-success">Create Part & Match</button>
            </div>
        </form>
    </div>
</div>

<script>
let searchTimeout = null;
const csrfToken = '{{ csrf_token }}';
const supplierId = {{ invoice.supplier.pk }};

document.querySelectorAll('.search-input').forEach(input => {
    const itemId = input.dataset.itemId;
    const resultsDiv = document.getElementById('results-' + itemId);

    input.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();

        if (query.length < 2) {
            resultsDiv.classList.remove('show');
            return;
        }

        searchTimeout = setTimeout(() => {
            searchParts(query, itemId, resultsDiv);
        }, 300);
    });

    input.addEventListener('focus', function() {
        if (this.value.length >= 2) {
            resultsDiv.classList.add('show');
        }
    });

    // Hide results when clicking outside
    document.addEventListener('click', function(e) {
        if (!input.contains(e.target) && !resultsDiv.contains(e.target)) {
            resultsDiv.classList.remove('show');
        }
    });
});

function searchParts(query, itemId, resultsDiv) {
    fetch(`{% url 'admin:invoice_manager_search_parts' %}?q=${encodeURIComponent(query)}&supplier={{ invoice.supplier.pk }}`)
        .then(response => response.json())
        .then(data => {
            resultsDiv.innerHTML = '';
            if (data.parts.length === 0) {
                resultsDiv.innerHTML = '<div class="search-result-item">No parts found</div>';
            } else {
                data.parts.forEach(part => {
                    const div = document.createElement('div');
                    div.className = 'search-result-item';
                    div.innerHTML = `<strong>${part.name}</strong><br><small>IPN: ${part.IPN || 'N/A'}</small>`;
                    div.onclick = () => selectPart(itemId, part.id, part.name);
                    resultsDiv.appendChild(div);
                });
            }
            resultsDiv.classList.add('show');
        });
}

function selectPart(itemId, partId, partName) {
    const input = document.querySelector(`.search-input[data-item-id="${itemId}"]`);
    const hiddenInput = input.parentElement.querySelector('.part-id-input');
    const resultsDiv = document.getElementById('results-' + itemId);

    input.value = partName;
    hiddenInput.value = partId;
    resultsDiv.classList.remove('show');

    // Update row styling
    const row = input.closest('tr');
    row.classList.remove('unmatched');
    row.classList.add('matched');

    // Update status badge
    const badge = row.querySelector('.status-badge');
    badge.className = 'status-badge status-matched';
    badge.textContent = '‚úì Matched';

    // Hide create button
    const createBtn = row.querySelector('.btn-create-part');
    if (createBtn) createBtn.style.display = 'none';

    // Update summary
    updateSummary();
}

function updateSummary() {
    const matched = document.querySelectorAll('tr.matched').length;
    const unmatched = document.querySelectorAll('tr.unmatched').length;

    document.querySelector('.summary-item.matched .number').textContent = matched;
    document.querySelector('.summary-item.unmatched .number').textContent = unmatched;
}

// Create Part Modal Functions
function openCreatePartModal(itemId, description, sku, price) {
    document.getElementById('modalItemId').value = itemId;
    document.getElementById('partName').value = description;
    document.getElementById('partDescription').value = description;
    document.getElementById('partSKU').value = sku;
    document.getElementById('partPrice').value = price || '';
    document.getElementById('createPartModal').classList.add('show');
}

function closeCreatePartModal() {
    document.getElementById('createPartModal').classList.remove('show');
}

// Handle form submission
document.getElementById('createPartForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const itemId = document.getElementById('modalItemId').value;
    const data = {
        name: document.getElementById('partName').value,
        description: document.getElementById('partDescription').value,
        category: document.getElementById('partCategory').value,
        sku: document.getElementById('partSKU').value,
        price: document.getElementById('partPrice').value,
        supplier_id: supplierId
    };

    fetch('{% url "admin:invoice_manager_create_part" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Select the newly created part
            selectPart(itemId, result.part_id, result.part_name);
            closeCreatePartModal();
            alert('Part created successfully!');
        } else {
            alert('Error: ' + result.error);
        }
    })
    .catch(err => {
        alert('Error creating part: ' + err);
    });
});

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeCreatePartModal();
    }
});
</script>
{% endblock content %}
